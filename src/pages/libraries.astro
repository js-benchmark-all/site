---
import Page from "$layouts/Page.astro";
---

<Page title="Benchmark results - startup & size">
  <div id="loading">Loading benchmark data...</div>
  <div id="root"></div>

  <script>
    import Chart from "chart.js/auto";
    import * as v from "valibot";
    import { actions } from "astro:actions";

    const ROBOTO_MONO = { family: "'Roboto Mono', monospace", size: 16 };
    const OPTIONS = {
      indexAxis: "y",
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            callback: (value: any) => +(+value).toFixed(2),
            font: ROBOTO_MONO,
          },
        },
        y: {
          ticks: {
            font: ROBOTO_MONO,
          },
        },
      },
      plugins: {
        legend: {
          display: true,
          position: "top",
          labels: {
            font: ROBOTO_MONO,
          },
        },
        tooltip: {
          bodyFont: ROBOTO_MONO,
          callbacks: {
            label: (ctx: any) =>
              ctx.dataset.label! + ": " + ctx.parsed.x.toFixed(2),
          },
        },
      },
      responsive: true,
      maintainAspectRatio: false,
      font: ROBOTO_MONO,
    } as const;

    const ROOT = document.getElementById("root")!;
    const LOADING = document.getElementById("loading")!;

    let currentID = 0;

    const createHeader = (text: string, type: number) => {
      const header = document.createElement("h" + type);
      header.textContent = text;
      header.id = "hd" + currentID++;
      header.onclick = () => {
        const currentURL = new URL(location.href);
        currentURL.hash = header.id;
        location.href = currentURL.href;
      };
      ROOT.appendChild(header);
      return header;
    };

    const createChart = (id: string) => {
      const section = document.createElement("section");
      section.className = "chart-container";

      const canvas = document.createElement("canvas");
      canvas.id = id;
      section.appendChild(canvas);

      ROOT.appendChild(section);
      return canvas;
    };

    const ChartData = v.object({
      labels: v.array(v.string()),
      datasets: v.array(
        v.object({
          label: v.string(),
          data: v.array(v.number()),
        }),
      ),
    });

    const load = (data: any, prev: string[]) => {
      if (v.is(ChartData, data))
        new Chart(
          createChart(prev.join("-").replace(/\W/g, "-")).getContext("2d")!,
          {
            type: "bar",
            data,
            options: OPTIONS,
          },
        );
      else {
        for (const name in data) {
          createHeader(name, prev.length + 1);
          load(data[name], prev.concat([name]));
        }
      }
    };

    // Correctly load the hash after load
    {
      const hash = location.hash;
      location.hash = "_";
      load(await actions.startupSize.orThrow(), []);
      if (hash !== "") location.hash = hash;
    }

    LOADING.style.display = "none";
    ROOT.style.display = "block";
  </script>

  <style is:global>
    body {
      margin: 20px;
      background: #f9f9f9;
      color: #333;
      text-align: center;
    }

    #root {
      display: none;
    }

    #loading {
      font-size: 1.5em;
      text-align: center;
      margin-top: 100px;
      color: #666;
    }

    .chart-container {
      width: 95%;
      max-width: 96rem;
      margin: 20px auto 40px auto;
      padding: 20px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      text-align: center;
    }

    canvas {
      display: inline-block;
    }

    h1 {
      font-weight: 700;
      font-size: 3em;
      margin-top: 1em;
      text-align: center;
      cursor: pointer;
    }

    h2 {
      font-weight: 600;
      font-size: 2.4em;
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      padding-bottom: 0.1em;
      text-align: center;
      cursor: pointer;
    }

    h3 {
      font-size: 1.5em;
      margin-top: 1.7em;
    }
  </style>
</Page>
